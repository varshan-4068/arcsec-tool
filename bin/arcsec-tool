#!/usr/bin/env bash

# arsectool - Arch Linux Security Quick Check
# Author: Sirivarshan K
# Github: https://github.com/varshan-4068/
# License: MIT

COLOR1=$(tput setaf 2)
COLOR2=$(tput setaf 7)
RESET=$(tput sgr0)

CRITICAL=0
WARN=0

help_flag() {
  cat << EOF

Usage:
	sudo arcsec-tool [OPTIONS]

Options:
	-h, --help      Show this help message and exit

Description:
	Performs basic security checks on an Arch Linux system:
	 - SSH configuration
	 - sudo privileges
	 - failed systemd services
	 - package updates
	 - orphaned packages
	 - firewall status

Notes:
	• Some checks require sudo privileges
	• Designed for Arch Linux and Arch-based systems
	• This script does not apply fixes automatically
	• Recommendation's and Fixes are provided for warning's

EOF
}

case "$1" in
  -h|--help)
    help_flag
    exit 0
    ;;
esac

if [[ $EUID -ne 0 ]]; then
	help_flag
	exit 1
fi

if ! command -v figlet &>/dev/null;then
	echo -e "Figlet Not Found!\n"
	sudo pacman -S figlet
fi


if ! command -v gum &>/dev/null; then
  echo -e "Gum Not Found!\n"
  sudo pacman -S --noconfirm gum
fi

print_logo(){

cat << EOF

$(figlet "SECURITY CHECK")

EOF

}

clear
print_logo

echo -e "${COLOR1}══ Arch Security Quick Check ══${COLOR2}\n"

SSHD="/etc/ssh/sshd_config"

if [[ -f "$SSHD" ]] && grep -Eq "^\s*PermitRootLogin\s+yes" "$SSHD" 2>/dev/null; then
  echo -e "${COLOR1}[CRITICAL] SSH root login enabled${COLOR2}"
  echo "[FIX]: Set PermitRootLogin no in /etc/ssh/sshd_config"
  ((CRITICAL++))
else
  echo -e "${COLOR1}[OK] SSH root login disabled${COLOR2}"
fi

if [[ -f "$SSHD" ]] && grep -q "^\s*PasswordAuthentication\s+yes" "$SSHD" 2>/dev/null; then
  echo -e "${COLOR1}[WARN] SSH password authentication enabled${COLOR2}"
  echo "[RECOMMENDATION]: Use SSH keys only"
  ((WARN++))
else
  echo -e "${COLOR1}[OK] SSH password authentication disabled${COLOR2}"
fi

sudoers=/etc/sudoers

if sudo grep -Eq '^\s*#.*NOPASSWD' "$sudoers" 2>/dev/null; then
  echo -e "${COLOR1}[OK] Sudo requires password${COLOR2}"
else
  echo -e "${COLOR1}[WARN] NOPASSWD sudo rules detected${COLOR2}"
  ((WARN++))
fi


FAIL=$(systemctl --failed --no-legend 2>/dev/null | wc -l)

if [ "$FAIL" -eq 0 ]; then
  echo -e "${COLOR1}[OK] No Systemd Failed Services Found${COLOR2}"
else
	echo -e "${COLOR1}[WARN] $FAIL Failed Systemd Services Found${COLOR2}"
	((WARN++))
fi

if gum spin --spinner points --title "Updating System Packages…" -- sudo pacman -Syu --quiet; then
  gum style --foreground 2 "[OK] Package database updated"
else
  gum style --foreground 1 "[WARN] Failed to update package database"
	((WARN++))
fi

UPDATES=$(pacman -Qu 2>/dev/null | wc -l)
if [[ "$UPDATES" -gt 0 ]]; then
  echo -e "${COLOR1}[WARN] $UPDATES pending updates${COLOR2}"
  ((WARN++))
else
  echo -e "${COLOR1}[OK] System up to date${COLOR2}"
fi

ORPHAN=$(pacman -Qdt | wc -l)

if [[ "$ORPHAN" -gt 0 ]]; then
	echo -e "${COLOR1}[WARN] $ORPHAN Orphaned Packages Found${COLOR2}"
	echo -e "${COLOR2}[Fix] Use \"sudo pacman -Rns \$(pacman -Qdt | awk '{print \$1}')\""
	((WARN++))
else
	echo -e "${COLOR1}[OK] No Orphaned Packages Found${COLOR2}"
fi

if command -v ufw &>/dev/null && sudo ufw status | grep -q "^Status: active" \
	 || systemctl is-active --quiet ufw \
	 || systemctl is-active --quiet firewalld \
	 || systemctl is-active --quiet nftables; then
	echo -e "${COLOR1}[OK] Firewall Enabled..."
else
	echo -e "${COLOR1}[WARN] Firewall Not Enabled...${COLOR2}"
	((WARN++))
fi

echo -e "\n${COLOR1}══ Summary ══${COLOR2}"
echo -e "Critical issues: ${COLOR2}$CRITICAL${COLOR2}"
echo -e "Warnings: ${COLOR2}$WARN${COLOR1}"

if [[ "$CRITICAL" -gt 0 ]]; then
  echo -e "\n${COLOR1}System is NOT secure.${COLOR2}\n"
else
  echo -e "\n${COLOR1}No critical security issues found.${RESET}\n"
fi

read -rp "Press Enter to Close"

